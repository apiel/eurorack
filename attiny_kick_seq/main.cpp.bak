#include <Arduino.h>

// Pin Definitions
const int PIN_TRIGGER = 1; // with Led
const int PIN_CLOCK = 2;
const int PIN_SHIFT = 3;  // Hold this to change BPM
const int PIN_REPEAT = 4; // Also BPM UP
const int PIN_MUTE = 5;   // Also BPM DOWN

// Timing & Logic
int bpm = 160;
unsigned long lastStepTime = 0;
int stepCounter = 0;
bool lastWasGhost = false;

// Debouncing for BPM buttons
bool upPressed = false;
bool downPressed = false;

void setup()
{
  pinMode(PIN_TRIGGER, OUTPUT);
  pinMode(PIN_CLOCK, OUTPUT);
  pinMode(PIN_SHIFT, INPUT_PULLUP);
  pinMode(PIN_REPEAT, INPUT_PULLUP);
  pinMode(PIN_MUTE, INPUT_PULLUP);

  randomSeed(analogRead(A1)); // Seed from the now-empty Analog pin
}

void loop()
{
  bool shiftHeld = (digitalRead(PIN_SHIFT) == LOW);

  // --- BPM Change Logic (Only when Shift is held) ---
  if (shiftHeld)
  {
    // Check UP button
    if (digitalRead(PIN_REPEAT) == LOW && !upPressed)
    {
      bpm = min(bpm + 5, 300); // Cap at 300 BPM
      upPressed = true;
    }
    else if (digitalRead(PIN_REPEAT) == HIGH)
    {
      upPressed = false;
    }

    // Check DOWN button
    if (digitalRead(PIN_MUTE) == LOW && !downPressed)
    {
      bpm = max(bpm - 5, 40); // Floor at 40 BPM
      downPressed = true;
    }
    else if (digitalRead(PIN_MUTE) == HIGH)
    {
      downPressed = false;
    }
  }

  // --- Sequencer Logic ---
  unsigned long stepDuration = 15000 / bpm;

  if (millis() - lastStepTime >= stepDuration)
  {
    lastStepTime = millis();

    bool isMuted = (digitalRead(PIN_MUTE) == LOW && !shiftHeld);
    bool isRepeat = (digitalRead(PIN_REPEAT) == LOW && !shiftHeld);
    bool triggerNow = false;

    int positionInBar = stepCounter % 4;

    if (isRepeat)
    {
      triggerNow = true;
    }
    else
    {
      if (positionInBar == 0)
      {
        if (lastWasGhost || random(100) > 5)
        {
          triggerNow = true;
          lastWasGhost = false;
        }
      }
      else
      {
        if (random(100) < 10)
        {
          triggerNow = true;
          lastWasGhost = true;
        }
        else
        {
          lastWasGhost = false;
        }
      }
    }

    // --- Output Execution ---

    // CLOCK: Only pulse HIGH on the downbeat (every 4th 16th-note)
    if (positionInBar == 0)
    {
      digitalWrite(PIN_CLOCK, HIGH);
    }

    // TRIGGER: Pulse on the generative steps (16th notes)
    if (triggerNow && !isMuted)
    {
      digitalWrite(PIN_TRIGGER, HIGH);
    }

    delay(10); // Pulse width
    digitalWrite(PIN_CLOCK, LOW);
    digitalWrite(PIN_TRIGGER, LOW);

    stepCounter++;
  }
}